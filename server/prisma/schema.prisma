generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String     @id @default(uuid())
  email             String     @unique
  username          String     @unique
  password          String
  displayName       String?
  avatar            String?
  bio               String?
  status            UserStatus @default(OFFLINE)
  lastSeen          DateTime   @default(now())
  emailVerified     Boolean    @default(false)
  verificationToken String?
  pushSubscription  String?
  theme             String?    @default("light")
  showOnlineStatus  Boolean    @default(true)
  showProfilePhoto  Boolean    @default(true)
  showLastSeen      Boolean    @default(true)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  sentMessages     Message[]         @relation("MessageSender")
  chatMembers      ChatMember[]
  calls            Call[]            @relation("CallInitiator")
  callParticipants CallParticipant[]
  contacts         Contact[]         @relation("UserContacts")
  contactOf        Contact[]         @relation("ContactUser")
  reactions        Reaction[]
  blockedUsers     BlockedUser[]     @relation("BlockingUser")
  blockedBy        BlockedUser[]     @relation("BlockedUser")
  chatSettings     ChatSettings[]
  folders          Folder[]
  pinnedMessages   PinnedMessage[]

  @@index([email])
  @@index([username])
  @@index([verificationToken])
}

enum UserStatus {
  ONLINE
  OFFLINE
  AWAY
  DO_NOT_DISTURB
}

model Chat {
  id          String   @id @default(uuid())
  name        String?
  type        ChatType
  avatar      String?
  description String?
  isSecret    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members        ChatMember[]
  messages       Message[]
  calls          Call[]
  chatSettings   ChatSettings[]
  pinnedMessages PinnedMessage[]

  @@index([type])
  @@index([isSecret])
}

enum ChatType {
  PRIVATE
  GROUP
  CHANNEL
}

model ChatMember {
  id       String     @id @default(uuid())
  userId   String
  chatId   String
  role     MemberRole @default(MEMBER)
  joinedAt DateTime   @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([userId, chatId])
  @@index([userId])
  @@index([chatId])
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

model Message {
  id           String      @id @default(uuid())
  content      String?
  type         MessageType @default(TEXT)
  senderId     String
  chatId       String
  replyToId    String?
  fileUrl      String?
  fileName     String?
  fileSize     Int?
  thumbnailUrl String?
  duration     Int?
  waveform     String?
  stickerId    String?
  isEdited     Boolean     @default(false)
  isDeleted    Boolean     @default(false)
  isSilent     Boolean     @default(false)
  scheduledFor DateTime?
  isSent       Boolean     @default(false)
  mentions     String[]    @default([])
  hashtags     String[]    @default([])
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  sender    User            @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  chat      Chat            @relation(fields: [chatId], references: [id], onDelete: Cascade)
  replyTo   Message?        @relation("MessageReply", fields: [replyToId], references: [id])
  replies   Message[]       @relation("MessageReply")
  reactions Reaction[]
  pinnedBy  PinnedMessage[]

  @@index([chatId])
  @@index([senderId])
  @@index([createdAt])
  @@index([scheduledFor])
  @@index([mentions])
  @@index([hashtags])
  @@index([stickerId])
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  FILE
  VOICE
  SYSTEM
  GIF
  STICKER
}

model Call {
  id             String     @id @default(uuid())
  chatId         String
  initiatorId    String
  type           CallType
  status         CallStatus @default(CALLING)
  isRecording    Boolean    @default(false)
  recordingUrl   String?
  startedAt      DateTime   @default(now())
  endedAt        DateTime?

  chat         Chat              @relation(fields: [chatId], references: [id], onDelete: Cascade)
  initiator    User              @relation("CallInitiator", fields: [initiatorId], references: [id], onDelete: Cascade)
  participants CallParticipant[]

  @@index([chatId])
  @@index([status])
}

enum CallType {
  AUDIO
  VIDEO
}

enum CallStatus {
  CALLING
  ACTIVE
  ENDED
  MISSED
  DECLINED
}

model CallParticipant {
  id       String    @id @default(uuid())
  callId   String
  userId   String
  joinedAt DateTime  @default(now())
  leftAt   DateTime?

  call Call @relation(fields: [callId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([callId, userId])
  @@index([callId])
  @@index([userId])
}

model Contact {
  id        String   @id @default(uuid())
  userId    String
  contactId String
  nickname  String?
  createdAt DateTime @default(now())

  user    User @relation("UserContacts", fields: [userId], references: [id], onDelete: Cascade)
  contact User @relation("ContactUser", fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([userId, contactId])
  @@index([userId])
}

model Reaction {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

model BlockedUser {
  id        String   @id @default(uuid())
  userId    String
  blockedId String
  createdAt DateTime @default(now())

  user    User @relation("BlockingUser", fields: [userId], references: [id], onDelete: Cascade)
  blocked User @relation("BlockedUser", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([userId, blockedId])
  @@index([userId])
  @@index([blockedId])
}

model ChatSettings {
  id                String   @id @default(uuid())
  userId            String
  chatId            String
  isMuted           Boolean  @default(false)
  isFavorite        Boolean  @default(false)
  isArchived        Boolean  @default(false)
  folderId          String?
  unreadCount       Int      @default(0)
  lastReadMessageId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  chat   Chat    @relation(fields: [chatId], references: [id], onDelete: Cascade)
  folder Folder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@unique([userId, chatId])
  @@index([userId])
  @@index([chatId])
  @@index([folderId])
  @@index([isFavorite])
  @@index([isArchived])
}

model Folder {
  id        String   @id @default(uuid())
  userId    String
  name      String
  color     String?
  icon      String?
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatSettings ChatSettings[]

  @@index([userId])
  @@index([order])
}

model PinnedMessage {
  id        String   @id @default(uuid())
  userId    String
  messageId String
  chatId    String
  pinnedAt  DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  chat    Chat    @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([userId, messageId, chatId])
  @@index([userId])
  @@index([messageId])
  @@index([chatId])
}

model StickerPack {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  thumbnail   String?
  isPublic    Boolean   @default(true)
  creatorId   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  stickers Sticker[]

  @@index([slug])
  @@index([creatorId])
  @@index([isPublic])
}

model Sticker {
  id        String   @id @default(uuid())
  packId    String
  emoji     String?
  imageUrl  String
  width     Int
  height    Int
  order     Int      @default(0)
  createdAt DateTime @default(now())

  pack StickerPack @relation(fields: [packId], references: [id], onDelete: Cascade)

  @@index([packId])
}

model Bot {
  id          String    @id @default(uuid())
  username    String    @unique
  displayName String
  description String?
  avatar      String?
  token       String    @unique
  isActive    Boolean   @default(true)
  isInline    Boolean   @default(false)
  ownerId     String
  webhookUrl  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  commands BotCommand[]
  webhooks Webhook[]

  @@index([token])
  @@index([username])
  @@index([ownerId])
  @@index([isActive])
}

model BotCommand {
  id          String   @id @default(uuid())
  botId       String
  command     String
  description String
  createdAt   DateTime @default(now())

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, command])
  @@index([botId])
}

model Webhook {
  id          String       @id @default(uuid())
  botId       String
  url         String
  events      String[]
  isActive    Boolean      @default(true)
  secret      String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  bot          Bot           @relation(fields: [botId], references: [id], onDelete: Cascade)
  deliveries   WebhookDelivery[]

  @@index([botId])
  @@index([isActive])
}

model WebhookDelivery {
  id          String   @id @default(uuid())
  webhookId   String
  event       String
  payload     String
  status      Int
  response    String?
  attempts    Int      @default(0)
  deliveredAt DateTime @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([deliveredAt])
}
