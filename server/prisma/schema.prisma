generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                     String               @id @default(uuid())
  email                  String               @unique
  username               String               @unique
  password               String
  displayName            String?
  avatar                 String?
  bio                    String?
  status                 UserStatus           @default(OFFLINE)
  lastSeen               DateTime             @default(now())
  emailVerified          Boolean              @default(false)
  verificationToken      String?
  pushSubscription       String?
  theme                  String?              @default("light")
  showOnlineStatus       Boolean              @default(true)
  showProfilePhoto       Boolean              @default(true)
  showLastSeen           Boolean              @default(true)
  notificationsPush      Boolean              @default(true)
  notificationsEmail     Boolean              @default(true)
  notificationsSound     Boolean              @default(true)
  notificationsVibration Boolean              @default(true)
  telegramId             String?              @unique
  telegramUsername       String?
  telegramFirstName      String?
  telegramLastName       String?
  telegramPhotoUrl       String?
  telegramAuthDate       DateTime?
  telegramNotifications  Boolean              @default(false)
  telegramSyncMessages   Boolean              @default(false)
  telegramSyncProfile    Boolean              @default(false)
  twoFactorEnabled       Boolean              @default(false)
  twoFactorSecret        String?
  backupCodes            String?
  failedLoginAttempts    Int                  @default(0)
  lockedUntil            DateTime?
  trustedIPs             String?
  publicKey              String?
  encryptedPrivateKey    String?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  blockedBy              BlockedUser[]        @relation("BlockedUser")
  blockedUsers           BlockedUser[]        @relation("BlockingUser")
  calls                  Call[]               @relation("CallInitiator")
  callParticipants       CallParticipant[]
  chatMembers            ChatMember[]
  chatSettings           ChatSettings[]
  contactOf              Contact[]            @relation("ContactUser")
  contacts               Contact[]            @relation("UserContacts")
  folders                Folder[]
  ipBlacklist            IPBlacklist[]
  sentMessages           Message[]            @relation("MessageSender")
  pinnedMessages         PinnedMessage[]
  reactions              Reaction[]
  securityLogs           SecurityLog[]
  telegramBridges        TelegramChatBridge[]
  sessions               UserSession[]
  themes                 UserTheme[]
  readMessages           MessageRead[]

  @@index([email])
  @@index([username])
  @@index([verificationToken])
  @@index([telegramId])
}

model UserSession {
  id               String   @id @default(uuid())
  userId           String
  refreshTokenHash String
  device           String?
  ipAddress        String
  userAgent        String?
  lastActive       DateTime @default(now())
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshTokenHash])
  @@index([lastActive])
}

model Chat {
  id              String              @id @default(uuid())
  name            String?
  type            ChatType
  avatar          String?
  description     String?
  isSecret        Boolean             @default(false)
  encryptionKeyId String?
  encryptionType  String?             @default("none")
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  calls           Call[]
  encryptionKeys  ChatEncryptionKey[]
  members         ChatMember[]
  chatSettings    ChatSettings[]
  messages        Message[]
  pinnedMessages  PinnedMessage[]

  @@index([type])
  @@index([isSecret])
}

model ChatMember {
  id       String     @id @default(uuid())
  userId   String
  chatId   String
  role     MemberRole @default(MEMBER)
  joinedAt DateTime   @default(now())
  chat     Chat       @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, chatId])
  @@index([userId])
  @@index([chatId])
}

model Message {
  id                  String          @id @default(uuid())
  content             String?
  type                MessageType     @default(TEXT)
  senderId            String
  chatId              String
  replyToId           String?
  forwardedFromId     String?
  forwardedFromChatId String?
  forwardedFromUserId String?
  isForwarded         Boolean         @default(false)
  fileUrl             String?
  fileName            String?
  fileSize            Int?
  thumbnailUrl        String?
  duration            Int?
  waveform            String?
  stickerId           String?
  isEdited            Boolean         @default(false)
  isDeleted           Boolean         @default(false)
  isSilent            Boolean         @default(false)
  scheduledFor        DateTime?
  expiresAt           DateTime?
  isSent              Boolean         @default(false)
  mentions            String?
  hashtags            String?
  linkPreview         Json?
  isEncrypted         Boolean         @default(false)
  encryptedContent    String?
  encryptionKeyId     String?
  isCompressed        Boolean         @default(false)
  originalFileUrl     String?
  videoFormats        String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  replyTo             Message?        @relation("MessageReply", fields: [replyToId], references: [id])
  replies             Message[]       @relation("MessageReply")
  chat                Chat            @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender              User            @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  pinnedBy            PinnedMessage[]
  reactions           Reaction[]
  reads               MessageRead[]

  @@index([chatId])
  @@index([senderId])
  @@index([createdAt])
  @@index([scheduledFor])
  @@index([expiresAt])
  @@index([mentions])
  @@index([hashtags])
  @@index([stickerId])
}

model Call {
  id           String            @id @default(uuid())
  chatId       String
  initiatorId  String
  type         CallType
  status       CallStatus        @default(CALLING)
  isRecording  Boolean           @default(false)
  recordingUrl String?
  startedAt    DateTime          @default(now())
  endedAt      DateTime?
  initiator    User              @relation("CallInitiator", fields: [initiatorId], references: [id], onDelete: Cascade)
  chat         Chat              @relation(fields: [chatId], references: [id], onDelete: Cascade)
  participants CallParticipant[]

  @@index([chatId])
  @@index([status])
}

model CallParticipant {
  id       String    @id @default(uuid())
  callId   String
  userId   String
  joinedAt DateTime  @default(now())
  leftAt   DateTime?
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  call     Call      @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@unique([callId, userId])
  @@index([callId])
  @@index([userId])
}

model Contact {
  id        String   @id @default(uuid())
  userId    String
  contactId String
  nickname  String?
  createdAt DateTime @default(now())
  contact   User     @relation("ContactUser", fields: [contactId], references: [id], onDelete: Cascade)
  user      User     @relation("UserContacts", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, contactId])
  @@index([userId])
}

model Reaction {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

model MessageRead {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
  @@index([readAt])
}

model BlockedUser {
  id        String   @id @default(uuid())
  userId    String
  blockedId String
  createdAt DateTime @default(now())
  blocked   User     @relation("BlockedUser", fields: [blockedId], references: [id], onDelete: Cascade)
  user      User     @relation("BlockingUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, blockedId])
  @@index([userId])
  @@index([blockedId])
}

model ChatSettings {
  id                String   @id @default(uuid())
  userId            String
  chatId            String
  isMuted           Boolean  @default(false)
  isFavorite        Boolean  @default(false)
  isArchived        Boolean  @default(false)
  folderId          String?
  unreadCount       Int      @default(0)
  lastReadMessageId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  folder            Folder?  @relation(fields: [folderId], references: [id])
  chat              Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, chatId])
  @@index([userId])
  @@index([chatId])
  @@index([folderId])
  @@index([isFavorite])
  @@index([isArchived])
}

model Folder {
  id           String         @id @default(uuid())
  userId       String
  name         String
  color        String?
  icon         String?
  order        Int            @default(0)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  chatSettings ChatSettings[]
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([order])
}

model PinnedMessage {
  id        String   @id @default(uuid())
  userId    String
  messageId String
  chatId    String
  pinnedAt  DateTime @default(now())
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, messageId, chatId])
  @@index([userId])
  @@index([messageId])
  @@index([chatId])
}

model StickerPack {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  thumbnail   String?
  isPublic    Boolean   @default(true)
  creatorId   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  stickers    Sticker[]

  @@index([slug])
  @@index([creatorId])
  @@index([isPublic])
}

model Sticker {
  id        String      @id @default(uuid())
  packId    String
  emoji     String?
  imageUrl  String
  width     Int
  height    Int
  order     Int         @default(0)
  createdAt DateTime    @default(now())
  pack      StickerPack @relation(fields: [packId], references: [id], onDelete: Cascade)

  @@index([packId])
}

model Bot {
  id               String              @id @default(uuid())
  username         String              @unique
  displayName      String
  description      String?
  avatar           String?
  token            String              @unique
  isActive         Boolean             @default(true)
  isInline         Boolean             @default(false)
  ownerId          String
  webhookUrl       String?
  messagesSent     Int                 @default(0)
  messagesReceived Int                 @default(0)
  uniqueUsers      Int                 @default(0)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  analytics        BotAnalytics[]
  commands         BotCommand[]
  inlineKeyboards  BotInlineKeyboard[]
  webhooks         Webhook[]

  @@index([token])
  @@index([username])
  @@index([ownerId])
  @@index([isActive])
}

model BotCommand {
  id          String   @id @default(uuid())
  botId       String
  command     String
  description String
  createdAt   DateTime @default(now())
  bot         Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, command])
  @@index([botId])
}

model Webhook {
  id         String            @id @default(uuid())
  botId      String
  url        String
  events     String?
  isActive   Boolean           @default(true)
  secret     String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  bot        Bot               @relation(fields: [botId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([botId])
  @@index([isActive])
}

model WebhookDelivery {
  id          String   @id @default(uuid())
  webhookId   String
  event       String
  payload     String
  status      Int
  response    String?
  attempts    Int      @default(0)
  deliveredAt DateTime @default(now())
  webhook     Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([deliveredAt])
}

model TelegramChatBridge {
  id               String                @id @default(uuid())
  userId           String
  stogramChatId    String
  telegramChatId   String
  telegramChatType String
  isActive         Boolean               @default(true)
  syncDirection    SyncDirection         @default(BIDIRECTIONAL)
  lastSyncAt       DateTime?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  user             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  syncedMessages   TelegramMessageSync[]

  @@unique([stogramChatId, telegramChatId])
  @@index([userId])
  @@index([stogramChatId])
  @@index([telegramChatId])
  @@index([isActive])
}

model TelegramMessageSync {
  id                String             @id @default(uuid())
  bridgeId          String
  stogramMessageId  String?
  telegramMessageId String
  direction         String
  syncedAt          DateTime           @default(now())
  bridge            TelegramChatBridge @relation(fields: [bridgeId], references: [id], onDelete: Cascade)

  @@unique([bridgeId, telegramMessageId])
  @@index([bridgeId])
  @@index([stogramMessageId])
  @@index([telegramMessageId])
}

model TelegramMiniAppSession {
  id             String   @id @default(uuid())
  userId         String
  telegramUserId String
  initData       String
  initDataUnsafe String
  queryId        String?
  platform       String?
  version        String?
  isActive       Boolean  @default(true)
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
  @@index([telegramUserId])
  @@index([queryId])
  @@index([isActive])
  @@index([expiresAt])
}

model ChatEncryptionKey {
  id         String    @id @default(uuid())
  chatId     String
  keyVersion Int       @default(1)
  publicKey  String
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?
  chat       Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([keyVersion])
}

model SecurityLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  ipAddress String
  userAgent String?
  location  String?
  success   Boolean  @default(true)
  details   String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([ipAddress])
  @@index([createdAt])
}

model IPBlacklist {
  id        String    @id @default(uuid())
  userId    String?
  ipAddress String
  reason    String
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ipAddress])
  @@index([expiresAt])
}

model SpamReport {
  id         String    @id @default(uuid())
  reporterId String
  targetId   String
  targetType String
  reason     String
  status     String    @default("pending")
  reviewedBy String?
  reviewedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([targetId])
  @@index([targetType])
  @@index([status])
  @@index([createdAt])
}

model BotInlineKeyboard {
  id        String   @id @default(uuid())
  botId     String
  name      String
  buttons   String
  createdAt DateTime @default(now())
  bot       Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
}

model BotCallbackQuery {
  id           String   @id @default(uuid())
  botId        String
  userId       String
  messageId    String
  callbackData String
  answered     Boolean  @default(false)
  answerText   String?
  createdAt    DateTime @default(now())

  @@index([botId])
  @@index([userId])
  @@index([messageId])
  @@index([answered])
}

model BotInlineQuery {
  id        String   @id @default(uuid())
  botId     String
  userId    String
  query     String
  offset    String?
  answered  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([botId])
  @@index([userId])
  @@index([answered])
}

model BotAnalytics {
  id               String   @id @default(uuid())
  botId            String
  date             DateTime
  messagesSent     Int      @default(0)
  messagesReceived Int      @default(0)
  uniqueUsers      Int      @default(0)
  commands         String?
  bot              Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, date])
  @@index([botId])
  @@index([date])
}

model UserAnalytics {
  id               String   @id @default(uuid())
  userId           String
  date             DateTime
  messagesSent     Int      @default(0)
  messagesReceived Int      @default(0)
  callsMade        Int      @default(0)
  callsReceived    Int      @default(0)
  activeMinutes    Int      @default(0)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model SystemAnalytics {
  id              String   @id @default(uuid())
  date            DateTime @unique
  totalUsers      Int      @default(0)
  activeUsers     Int      @default(0)
  totalMessages   Int      @default(0)
  totalCalls      Int      @default(0)
  totalStorage    BigInt   @default(0)
  avgResponseTime Int      @default(0)
  errorCount      Int      @default(0)

  @@index([date])
}

model UserTheme {
  id        String   @id @default(uuid())
  userId    String
  name      String
  colors    String
  isDark    Boolean  @default(false)
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model MessageCache {
  id         String   @id @default(uuid())
  chatId     String   @unique
  messageIds String
  lastUpdate DateTime @default(now())

  @@index([chatId])
  @@index([lastUpdate])
}

enum UserStatus {
  ONLINE
  OFFLINE
  AWAY
  DO_NOT_DISTURB
}

enum ChatType {
  PRIVATE
  GROUP
  CHANNEL
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  FILE
  VOICE
  SYSTEM
  GIF
  STICKER
}

enum CallType {
  AUDIO
  VIDEO
}

enum CallStatus {
  CALLING
  ACTIVE
  ENDED
  MISSED
  DECLINED
}

enum SyncDirection {
  TELEGRAM_TO_STOGRAM
  STOGRAM_TO_TELEGRAM
  BIDIRECTIONAL
}
