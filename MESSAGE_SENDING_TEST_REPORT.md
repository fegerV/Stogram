# –û—Ç—á–µ—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π, —Ñ–∞–π–ª–æ–≤, –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ

## –î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
2025-01-XX

## –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

1. **–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π**
   - ‚úÖ API endpoint: `POST /api/messages/:chatId`
   - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
   - ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Zod schema
   - ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Prisma
   - ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Socket.IO –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

2. **–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤**
   - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ Multer
   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (IMAGE, VIDEO, AUDIO, FILE)
   - ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤ (—Å–∂–∞—Ç–∏–µ, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é)
   - ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞ (–∏–º—è, —Ä–∞–∑–º–µ—Ä, URL)

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**
   - ‚úÖ –°–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ Sharp
   - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤: JPEG, PNG, GIF
   - ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏–π

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ**
   - ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é (thumbnail) —á–µ—Ä–µ–∑ FFmpeg
   - ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ
   - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤: MP4, MOV, AVI

5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ**
   - ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∞—É–¥–∏–æ
   - ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è waveform –¥–∞–Ω–Ω—ã—Ö
   - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤: MP3, WAV

6. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∫–ª–∏–µ–Ω—Ç–µ**
   - ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç `ChatWindow` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
   - ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ—Ç–∫—Ä—ã—Ç–∏—è –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
   - ‚úÖ –í–∏–¥–µ–æ –ø–ª–µ–µ—Ä —Å –∫–æ–Ω—Ç—Ä–æ–ª–∞–º–∏
   - ‚úÖ –ê—É–¥–∏–æ –ø–ª–µ–µ—Ä —Å –∫–æ–Ω—Ç—Ä–æ–ª–∞–º–∏
   - ‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

### ‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–§–∏–ª—å—Ç—Ä —Ñ–∞–π–ª–æ–≤ –≤ upload.ts**
   - ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –°–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ MIME-—Ç–∏–ø–æ–≤
   - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –û–±–Ω–æ–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤
   - üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è: –†–∞—Å—à–∏—Ä–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ MIME-—Ç–∏–ø–æ–≤ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ text/plain –∏ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤

2. **Rate Limiting**
   - ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –°–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
   - üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å rate limiting –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
   - ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –æ—à–∏–±–∫–∏ –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–æ
   - üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ messageController

### üìã –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏

#### –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å

**–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π** (`server/src/controllers/messageController.ts`):
- ‚úÖ `sendMessage` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ñ–∞–π–ª–∞–º–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞ —á–µ—Ä–µ–∑ `mediaService`
- ‚úÖ Socket.IO —Å–æ–±—ã—Ç–∏—è –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

**Middleware –∑–∞–≥—Ä—É–∑–∫–∏** (`server/src/middleware/upload.ts`):
- ‚úÖ Multer –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- ‚úÖ –§–∏–ª—å—Ç—Ä —Ñ–∞–π–ª–æ–≤ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω)
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (10MB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

**–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–µ–¥–∏–∞** (`server/src/services/mediaService.ts`):
- ‚úÖ `compressImage` - —Å–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- ‚úÖ `generateVideoThumbnail` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é –≤–∏–¥–µ–æ
- ‚úÖ `getVideoDuration` / `getAudioDuration` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ `generateAudioWaveform` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è waveform –¥–ª—è –∞—É–¥–∏–æ

#### –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç ChatWindow** (`client/src/components/ChatWindow.tsx`):
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –∫–ª–∏–∫–æ–º –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è
- ‚úÖ –í–∏–¥–µ–æ –ø–ª–µ–µ—Ä —Å –ø–æ—Å—Ç–µ—Ä–æ–º (thumbnail)
- ‚úÖ –ê—É–¥–∏–æ –ø–ª–µ–µ—Ä
- ‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

**Store** (`client/src/store/chatStore.ts`):
- ‚úÖ `sendMessage` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ API
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ FormData –¥–ª—è —Ñ–∞–π–ª–æ–≤
- ‚úÖ –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI

### üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `test-message-sending.js` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:
- –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
- –°–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ —á–∞—Ç–∞
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
- –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫**
   - –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `messageController`
   - –£–ª—É—á—à–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞

2. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –º–µ–¥–∏–∞**
   - –î–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤

3. **–£–ª—É—á—à–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

4. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã**
   - Unit —Ç–µ—Å—Ç—ã –¥–ª—è `mediaService`
   - E2E —Ç–µ—Å—Ç—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –¢–µ—Å—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤

### ‚úÖ –í—ã–≤–æ–¥—ã

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π, —Ñ–∞–π–ª–æ–≤, –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ **—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç**. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞ –º–µ—Å—Ç–µ:

- ‚úÖ API endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ Multer –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞ —á–µ—Ä–µ–∑ Sharp –∏ FFmpeg —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∫–ª–∏–µ–Ω—Ç–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Socket.IO —Ä–∞–±–æ—Ç–∞—é—Ç

**–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞:**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä —Ñ–∞–π–ª–æ–≤ –≤ `upload.ts`
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã
